name: CI

on:
  pull_request:
    branches: ["*"]
  push:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

permissions:
  contents: read

jobs:
  # Job 1: Security Audit (runs early to fail fast on vulnerabilities)
  security-audit:
    name: Security Audit
    timeout-minutes: 5
    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Check out code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
        with:
          version: 9.0.0

      - name: Setup Node.js environment
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: pnpm audit --audit-level critical

  # Job 2: Dockerfile Linting (Docker security best practice #10)
  dockerfile-lint:
    name: Dockerfile Lint
    timeout-minutes: 5
    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Check out code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Lint Dockerfiles
        uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf # v3.1.0
        with:
          dockerfile: apps/api/Dockerfile
          failure-threshold: warning

  # Job 3: Setup and Build (shared by all other jobs)
  setup-and-build:
    name: Setup and Build
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 2

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
        with:
          version: 9.0.0

      - name: Setup Node.js environment
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Restore Turborepo cache
        uses: actions/cache/restore@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Build
        run: pnpm build

      - name: Cache build artifacts
        uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: |
            .turbo
            node_modules
            packages/*/dist
            packages/*/node_modules
            apps/*/node_modules
            apps/*/dist
            pnpm-lock.yaml
          key: build-${{ github.sha }}

  # Job 4: Validation (typecheck + lint in parallel)
  validation:
    name: Validation
    needs: setup-and-build
    timeout-minutes: 5
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        check: [check-types, lint]

    steps:
      - name: Check out code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Restore workspace
        uses: ./.github/actions/restore-workspace

      - name: Run ${{ matrix.check }}
        run: pnpm ${{ matrix.check }}

      - name: Save Turbo cache
        uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}-validation-${{ matrix.check }}

  # Job 5: Tests
  tests:
    name: Tests
    needs: setup-and-build
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Restore workspace
        uses: ./.github/actions/restore-workspace

      - name: Run tests
        run: pnpm --filter @repo/api test:run

      - name: Save Turbo cache
        uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}-tests

  # Job 6: Release Gate (blocks merging until all tests pass)
  release-gate:
    name: Release Gate
    runs-on: ubuntu-latest
    needs:
      - security-audit
      - dockerfile-lint
      - validation
      - tests
    if: always()
    steps:
      - name: Check CI status
        run: |
          echo "=== Release Gate Status Check ==="

          FAILED=false

          check_job() {
            local job_name=$1
            local job_result=$2
            if [[ "$job_result" == "failure" || "$job_result" == "cancelled" ]]; then
              echo "❌ $job_name: $job_result"
              FAILED=true
            else
              echo "✅ $job_name: $job_result"
            fi
          }

          check_job "security-audit" "${{ needs.security-audit.result }}"
          check_job "dockerfile-lint" "${{ needs.dockerfile-lint.result }}"
          check_job "validation" "${{ needs.validation.result }}"
          check_job "tests" "${{ needs.tests.result }}"

          echo ""

          if [[ "$FAILED" == "true" ]]; then
            echo "❌ Release gate FAILED - one or more CI jobs failed or were cancelled"
            exit 1
          fi

          echo "✅ Release gate PASSED - all CI jobs succeeded"
